/**
 * @license
 * Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
 * This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
 * The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
 * The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
 * Code distributed by Google as part of the polymer project is also
 * subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
 */

import {PolymerElement, html} from '@polymer/polymer/polymer-element.js';
import { setPassiveTouchGestures, setRootPath } from '@polymer/polymer/lib/utils/settings.js';
// import '@polymer/app-layout/app-drawer/app-drawer.js';
// import '@polymer/app-layout/app-drawer-layout/app-drawer-layout.js';
// import '@polymer/app-layout/app-header/app-header.js';
// import '@polymer/app-layout/app-header-layout/app-header-layout.js';
// import '@polymer/app-layout/app-scroll-effects/app-scroll-effects.js';
// import '@polymer/app-layout/app-toolbar/app-toolbar.js';
// import '@polymer/app-route/app-location.js';
// import '@polymer/app-route/app-route.js';
// import '@polymer/iron-pages/iron-pages.js';
// import '@polymer/iron-selector/iron-selector.js';
// import '@polymer/paper-icon-button/paper-icon-button.js';
// import './my-icons.js';
import {style, map}from 'leaflet';
import leafletDraw from 'leaflet-draw';
import leafletDrawCss from 'leaflet-draw/dist/leaflet.draw-src.css'
import leafletCss from 'leaflet/dist/leaflet.css'
import template from './my-app.html'
// const styleElement = document.createElement('dom-module')
//
// styleElement.innerHTML =`
//   <template>
//     <style>
//       ${leafletCss}
//     </style>
//   </template>
// `
// styleElement.register('shared-styles')

class MyApp extends PolymerElement {
  static get template() {
    let tag = document.createElement('template');
    tag.innerHTML = `<style>${leafletCss}</style>${template}`;
    return tag;
  //   return html `
  //   <style include='shared-styles'></style>
  //   <div id='map' style='width: 900px; height: 500px'></div>
  //   `
    }
  ready(){
      super.ready();
      let map = L.map(this.$.map, { drawControl: true , crs: L.CRS.Simple});
      const iiif_svc = 'svc:iiif/full/full/0/default.jpg';
      const tsrct = 'svc:tesseract/full/full/0/default.jpg';
      const scaler = 10; //scale difference between pixels and lat/lon

      var img_host = 'http://localhost:3000/fcrepo/rest/';
      var img_loc = 'collection/example_3-catalogs/catalogs/199/media/images/199-3';
      var src = img_host + img_loc + '/' + iiif_svc;

      // Create new image  object, this will allow the pre-caching of the image before it loads into leaflet
      // This allows us to take the dimensions of the image and use them to define the bounds of the leaflet "map"
      var img = new Image();
      var imgH = 0;
      var imgW = 0;
      img.addEventListener("load",function(){
          imgH = this.naturalHeight;
          imgW = this.naturalWidth;
          let bounds = [[0,0], [imgH/10, imgW/scaler]];
          var image = L.imageOverlay(src, bounds).addTo(map);
          map.fitBounds(bounds);
      });
      // this MUST occur after the image load function, or it won't get the dimensions properly
      img.src = src;

      // Add the leaflet draw API to the image to allow the creation of boxes
      // TODO: remove ability to make shapes other than rectangles
      var drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);
      var drawControl = new L.Control.Draw({
          edit: {
              featureGroup: drawnItems
          }
      });

      // When a box is drawn on the image, same the box info (corners, dimensions, etc) create JSON object and
      // send to tesseract
      map.on('draw:created', function(e) {
          let type = e.layerType,
              layer = e.layer;

          let shape = layer.toGeoJSON();
          let shape_for_db = JSON.stringify(shape);
          console.log("Shape: " + shape_for_db);

          drawnItems.addLayer(layer);

          let coords = layer.getLatLngs();
          let box = JSON.stringify(convert(coords));
          console.log("Box: " + box);
          post(box);
      });


      // Send created JSON object to server to be run in tesseract
      // for now, print response to console
      function post(data){
          let xhr = new XMLHttpRequest();

          xhr.open("POST", 'tesseract', true);
          xhr.setRequestHeader("Content-Type", "application/json");
          xhr.onreadystatechange = function () {
              if (xhr.readyState === 4 && xhr.status === 200) {
                  console.log(this.responseText);
              }
          };
          xhr.send(data);
      }


      // Convert the coordinates generated by leaflet Draw into a format usable by tesseract
      // called in "map.on('draw:created', function(e)"
      function convert(coords){

          // lat = x, lon = y
          // rectangle drawn clockwise starting with south west corner
          // points need to be scaled up by 10 to equate to pixels
          let sw = upscale(coords[0]);
          let nw = upscale(coords[1]);
          let ne = upscale(coords[2]);
          let se = upscale(coords[3]);

          // Round values to remove any decimals, which would confuse tesseract
          let wdth = Math.round(se[0] - sw[0]);
          let hght = Math.round(ne[1] - se[1]);

          // leaflet calculates y as distance from bottom
          // tesseract y is distance from top
          // origin y = img height - nothern most y coordinate
          let x_loc = Math.round(nw[0]);
          let y_loc = Math.round(imgH - nw[1]);

          return {
              image_path:img_loc,
              box_x_loc:x_loc,
              box_y_loc:y_loc,
              box_width:wdth,
              box_height:hght,
              rotation_angle:0
          }
      }

      // scales the coordinates from latLon to pixels
      function upscale(latLon) {
          return [latLon["lng"] * scaler, latLon["lat"] * scaler]
      }

  }
}

window.customElements.define('my-app', MyApp);
